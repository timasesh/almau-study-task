{% load static %}
{% load course_extras %}
{% load course_filters %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Raleway:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <style>
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-right: 4px;
            margin-left: 30px;
        }
        .header-logo-stretch {
            height: 150px;
            width: auto;
            object-fit: contain;
            background: transparent;
            align-self: center;
        }
        .header-flex-row {
            display: flex;
            align-items: stretch;
        }
    </style>
</head>
<body>
<header class="course-header">
    <div class="header-flex-row">
        <div class="logo-container">
            <img src="/media/logo.png" alt="Logo" class="header-logo-stretch">
        </div>
        <div class="container d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="d-flex flex-column flex-md-row align-items-center gap-3">
                <div class="course-title">{{ course.title }}</div>
            </div>
            <div class="header-btns">
                <a href="{% url 'student_page' %}" class="btn btn-profile"><i class="fas fa-arrow-left mr-1"></i>Назад</a>
                <a href="{% url 'logout' %}" class="btn btn-logout"><i class="fas fa-sign-out-alt mr-1"></i>Выйти</a>
            </div>
        </div>
    </div>
</header>
<div class="course-progress-block-wide mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <span class="course-progress-label-wide">Общий прогресс по курсу:</span>
        <div class="progress course-progress-main-wide flex-grow-1 mx-3">
            <div class="progress-bar" role="progressbar"
                 style="width: {{ student_progress.progress|default:0 }}%"
                 aria-valuenow="{{ student_progress.progress|default:0 }}" aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <span class="progress-percentage-wide">{{ student_progress.progress|default:0 }}%</span>
    </div>
</div>
<main class="course-main d-flex">
    <aside class="sidebar-modules">
        <div class="sidebar-title">Модули и уроки</div>
        <div class="sidebar-modules-list">
            {% for module in course.modules.all %}
           {% if forloop.first or module.id in unlocked_modules %}
            <div class="sidebar-module">
                <div class="sidebar-module-title">{{ module.title }}</div>
                <ul class="sidebar-lessons-list">
                    {% for lesson in module.lessons.all %}
                        <li class="lesson-link"
                            data-lesson-id="{{ lesson.id }}"
                            data-video-url="{% if lesson.video %}{{ lesson.video.url }}{% elif lesson.video_url %}{{ lesson.video_url }}{% endif %}"
                            data-pdf-url="{% if lesson.pdf and not lesson.convert_pdf_to_slides %}{{ lesson.pdf.url }}{% endif %}"
                            {% if lesson.id != next_lesson_id_by_module|get_item:module.id and lesson.id not in completed_lessons %}class="disabled"{% endif %}>
                            {% if lesson.id in completed_lessons %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% endif %}
                            <span>{{ lesson.title }}</span>
                        </li>
                    {% endfor %}
                </ul>
                <ul class="sidebar-quiz-list">
                    {% for quiz in module.quizzes.all %}
                    <li>
                        <a href="{% url 'start_quiz' quiz.id %}" class="quiz-link">
                            <i class="fas fa-question-circle text-warning mr-2"></i>Квиз: {{ quiz.title }}
                        </a>
                        {% with result=quiz_results|get_item:quiz.id %}
                            {% if result %}
                                <span class="quiz-result">
                                    {% if result.passed %}
                                        <i class="fas fa-check-circle text-success"></i> Сдан ({{ result.score }}%)
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger"></i> Не сдан ({{ result.score }}%)
                                    {% endif %}
                                </span>
                            {% endif %}
                        {% endwith %}
                    </li>
                    {% endfor %}
                </ul>
                {% if module_can_be_completed|get_item:module.id %}
                <div class="text-center my-2">
                    <button class="btn btn-primary btn-block finish-module-btn" data-module-id="{{ module.id }}" data-course-id="{{ course.id }}">
                        <i class="fas fa-flag-checkered mr-1"></i> Завершить модуль
                    </button>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="sidebar-module disabled">
                <div class="sidebar-module-title">{{ module.title }} <span class="locked-icon" title="Завершите предыдущий модуль"><i class="fas fa-lock"></i></span></div>
                <ul class="sidebar-lessons-list">
                    {% for lesson in module.lessons.all %}
                        <li class="lesson-link disabled">
                            <span>{{ lesson.title }}</span>
                        </li>
                    {% endfor %}
                </ul>
                <ul class="sidebar-quiz-list">
                    {% for quiz in module.quizzes.all %}
                    <li class="quiz-link disabled">
                        <span>Квиз: {{ quiz.title }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </aside>
    <section class="main-course-content flex-grow-1">
        <div id="lesson-viewer" class="lesson-viewer mt-4" style="display:none;">
            <div class="lesson-viewer-card">
                <h2 class="text-center mb-4" id="lesson-viewer-title"></h2>
                <div id="video-container" class="mb-4"></div>
                <a id="pdf-link" href="#" target="_blank" class="btn btn-secondary mb-4" style="display: none;">Открыть PDF</a>
                <!-- PDF Slider Container -->
                <div id="pdf-slider-container" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button id="prev-slide-btn" class="btn btn-primary"><i class="fas fa-chevron-left"></i> Назад</button>
                        <span id="slide-info" class="fw-bold"></span>
                        <button id="next-slide-btn" class="btn btn-primary">Вперед <i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="text-center mb-3">
                        <img id="current-slide-img" src="" alt="Lesson Slide" class="img-fluid" style="max-height: 70vh;" />
                    </div>
                    <div class="text-center">
                        <button id="fullscreen-btn" class="btn btn-info"><i class="fas fa-expand"></i> Полный экран</button>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button id="close-lesson-viewer" class="btn btn-danger"><i class="fas fa-times"></i> Закрыть</button>
                    <button id="mark-complete-btn" class="btn btn-success ml-2"><i class="fas fa-check"></i> Завершить и продолжить</button>
                </div>
            </div>
        </div>
    </section>
</main>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

{# Этот скрипт содержит данные о слайдах, безопасно сериализованные Django #}
{{ all_lesson_slides_data|json_script:"all-lesson-slides-data" }}
{{ first_20_video_lessons|json_script:"first-20-video-lessons" }}

<script>
$(document).ready(function () {
    const allLessonSlidesData = JSON.parse(document.getElementById('all-lesson-slides-data').textContent);
    const first20VideoLessons = JSON.parse(document.getElementById('first-20-video-lessons').textContent);

    var currentLessonSlides = [];
    var currentSlideIndex = 0;
    var currentLessonId = null;
    var currentCourseId = {{ course.id }};
    var lessonStartTime = null;
    var timerInterval = null;
    var timerPassed = false;
    var slidesViewed = false;
    const REQUIRED_SECONDS = 20;

    function updateSlideDisplay() {
        if (currentLessonSlides && currentLessonSlides.length > 0) {
            $('#current-slide-img').attr('src', currentLessonSlides[currentSlideIndex]);
            $('#slide-info').text(`${currentSlideIndex + 1} / ${currentLessonSlides.length}`);
            $('#prev-slide-btn').prop('disabled', currentSlideIndex === 0);
            $('#next-slide-btn').prop('disabled', currentSlideIndex === currentLessonSlides.length - 1);
            // Проверяем, долистал ли до конца
            slidesViewed = (currentSlideIndex === currentLessonSlides.length - 1);
            checkLessonCompleteReady();
        }
    }

    function startLessonTimer() {
        lessonStartTime = Date.now();
        timerPassed = false;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            const elapsed = Math.floor((Date.now() - lessonStartTime) / 1000);
            const left = Math.max(0, REQUIRED_SECONDS - elapsed);
            console.log('Таймер урока:', left, 'секунд осталось');
            if (elapsed >= REQUIRED_SECONDS) {
                timerPassed = true;
                clearInterval(timerInterval);
                checkLessonCompleteReady();
            }
        }, 1000);
    }

    function checkLessonCompleteReady() {
        if (slidesViewed && timerPassed) {
            $('#mark-complete-btn').prop('disabled', false);
        } else {
            $('#mark-complete-btn').prop('disabled', true);
        }
    }

    $('#prev-slide-btn').click(function () {
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            updateSlideDisplay();
        }
    });

    $('#next-slide-btn').click(function () {
        if (currentSlideIndex < currentLessonSlides.length - 1) {
            currentSlideIndex++;
            updateSlideDisplay();
        }
    });

    $('#fullscreen-btn').click(function () {
        const img = $('#current-slide-img')[0];
        if (img.requestFullscreen) {
            img.requestFullscreen();
        } else if (img.mozRequestFullScreen) { /* Firefox */
            img.mozRequestFullScreen();
        } else if (img.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
            img.webkitRequestFullscreen();
        } else if (img.msRequestFullscreen) { /* IE/Edge */
            img.msRequestFullscreen();
        }
    });

    $('.lesson-link').not('.disabled').click(function () {
        currentLessonId = $(this).data('lesson-id');
        const videoUrl = $(this).data('video-url');
        const pdfUrl = $(this).data('pdf-url');
        let slidesData = allLessonSlidesData[currentLessonId];
        const lessonTitle = $(this).text().trim();
        $('#lesson-viewer-title').text(lessonTitle);
        // Скрываем все контейнеры по умолчанию
        $('#video-container').empty().hide();
        $('#pdf-link').hide();
        $('#pdf-slider-container').hide();
        $('#mark-complete-btn').show();
        let fallbackVideoTimer = null;
        function startFallbackVideoTimer() {
            let videoTimerSeconds = 60;
            if (first20VideoLessons.includes(currentLessonId)) {
                videoTimerSeconds = 20;
            }
            let timer = videoTimerSeconds;
            $('#mark-complete-btn').prop('disabled', true);
            fallbackVideoTimer = setInterval(function() {
                timer--;
                console.log('Таймер видео (fallback):', timer, 'секунд осталось');
                if (timer <= 0) {
                    clearInterval(fallbackVideoTimer);
                    $('#mark-complete-btn').prop('disabled', false);
                }
            }, 1000);
        }
        if (slidesData && slidesData.length > 0) {
            // --- Слайды ---
            currentLessonSlides = slidesData;
            currentSlideIndex = 0;
            updateSlideDisplay();
            $('#pdf-slider-container').show();
            startLessonTimer();
            checkLessonCompleteReady();
        } else if (videoUrl) {
            // --- Видео ---
            let embedHtml = '';
            let isYouTube = false;
            let isLocalVideo = false;
            let videoDuration = null;
            let fallbackStarted = false;
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                isYouTube = true;
                let videoId = '';
                if (videoUrl.includes('youtube.com/watch')) {
                    videoId = videoUrl.split('v=')[1];
                    const ampersandPosition = videoId.indexOf('&');
                    if (ampersandPosition !== -1) {
                        videoId = videoId.substring(0, ampersandPosition);
                    }
                } else if (videoUrl.includes('youtu.be/')) {
                    videoId = videoUrl.split('youtu.be/')[1];
                }
                if (videoId) {
                    embedHtml = `<div class="video-embed-container"><iframe id="yt-player" class="embedded-video-iframe" src="https://www.youtube.com/embed/${videoId}?enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                }
            } else if (videoUrl.match(/\.mp4($|\?)/) || videoUrl.includes('dropbox.com')) {
                isLocalVideo = true;
                let src = videoUrl;
                if (videoUrl.includes('dropbox.com')) {
                    src = videoUrl.replace('?dl=0', '?dl=1');
                }
                embedHtml = `<video id="lesson-video" controls class="local-video-player"><source src="${src}" type="video/mp4">Ваш браузер не поддерживает видео.</video>`;
            } else {
                // Остальные платформы (Vimeo, Google Drive и т.д.) — оставить как есть
            }
            if (embedHtml) {
                $('#video-container').html(embedHtml).show();
            } else {
                $('#video-container').html('<p class="text-danger">Не удалось загрузить видео или неподдерживаемый формат.</p>').show();
            }
            // --- Таймер для видео ---
            $('#mark-complete-btn').prop('disabled', true);
            let timerStarted = false;
            if (isLocalVideo) {
                const video = document.getElementById('lesson-video');
                video.onloadedmetadata = function() {
                    videoDuration = Math.floor(video.duration);
                    let timer = videoDuration;
                    timerStarted = true;
                    console.log('Таймер видео:', timer, 'секунд осталось');
                    let interval = setInterval(function() {
                        timer = Math.ceil(video.duration - video.currentTime);
                        console.log('Таймер видео:', timer, 'секунд осталось');
                        if (video.currentTime >= video.duration - 0.5) {
                            clearInterval(interval);
                            $('#mark-complete-btn').prop('disabled', false);
                        }
                    }, 1000);
                };
                // Если onloadedmetadata не сработал за 2 секунды — fallback
                setTimeout(function() {
                    if (!timerStarted) startFallbackVideoTimer();
                }, 2000);
            } else if (isYouTube) {
                window.onYouTubeIframeAPIReady = function() {
                    var player = new YT.Player('yt-player', {
                        events: {
                            'onReady': function(event) {
                                videoDuration = Math.floor(event.target.getDuration());
                                let timer = videoDuration;
                                timerStarted = true;
                                console.log('Таймер видео:', timer, 'секунд осталось');
                                let interval = setInterval(function() {
                                    event.target.getCurrentTimeAsync = function() {
                                        return new Promise(resolve => resolve(event.target.getCurrentTime()));
                                    };
                                    event.target.getCurrentTimeAsync().then(function(currentTime) {
                                        timer = Math.ceil(videoDuration - currentTime);
                                        console.log('Таймер видео:', timer, 'секунд осталось');
                                        if (currentTime >= videoDuration - 0.5) {
                                            clearInterval(interval);
                                            $('#mark-complete-btn').prop('disabled', false);
                                        }
                                    });
                                }, 1000);
                            }
                        }
                    });
                };
                setTimeout(function() {
                    if (!timerStarted) startFallbackVideoTimer();
                }, 2500);
                if (!window.YT) {
                    var tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api";
                    var firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                } else if (window.YT && window.YT.Player) {
                    window.onYouTubeIframeAPIReady();
                }
            } else {
                // Для остальных видео — fallback таймер
                startFallbackVideoTimer();
            }
        } else if (pdfUrl) {
            $('#pdf-link').attr('href', pdfUrl).show();
            $('#mark-complete-btn').prop('disabled', false);
        }
        $('#lesson-viewer').fadeIn();
        $('html,body').animate({scrollTop: $('#lesson-viewer').offset().top-40}, 400);
    });

    $('#mark-complete-btn').click(function() {
        if (currentLessonId) {
            $.ajax({
                url: '{% url "mark_lesson_complete" %}',
                type: 'POST',
                data: {
                    lesson_id: currentLessonId,
                    course_id: currentCourseId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        // Используем Bootstrap alert для более красивого отображения
                        // alert(response.message); 
                        showTemporaryAlert(response.message, 'success');

                        const completedLessonLink = $('.lesson-link[data-lesson-id="' + response.completed_lesson_id + '"]');
                        if (!completedLessonLink.find('.fa-check-circle').length) {
                            completedLessonLink.prepend('<i class="fas fa-check-circle text-success" style="margin-right:7px;"></i>');
                        }
                        // Удаляем класс 'disabled' с завершенного урока, чтобы он был кликабельным
                        completedLessonLink.removeClass('disabled'); 

                        // Обновляем прогресс-бар
                        $('.course-progress-main-wide .progress-bar').css('width', `${response.new_progress}%`);
                        $('.progress-percentage-wide').text(`${response.new_progress}%`);

                        if (response.next_lesson_id) {
                            const nextLessonLink = $('.lesson-link[data-lesson-id="' + response.next_lesson_id + '"]');
                            if (nextLessonLink.length) {
                                // Разблокируем следующий урок
                                nextLessonLink.removeClass('disabled');
                                // Закрываем текущий просмотрщик и открываем следующий урок
                                $('#lesson-viewer').fadeOut(function(){
                                    // Добавляем небольшую задержку перед кликом, чтобы анимация завершилась
                                    setTimeout(function() {
                                        nextLessonLink.click();
                                    }, 200); 
                                });
                            } else {
                                // Если следующего урока нет, просто скрываем просмотрщик
                                $('#lesson-viewer').fadeOut();
                            }
                        } else {
                            // Если нет следующего урока, просто скрываем просмотрщик
                            $('#lesson-viewer').fadeOut();
                        }
                    } else {
                        // alert(response.message);
                        showTemporaryAlert(response.message, 'info');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Ошибка при отметке урока:", xhr.responseText);
                    // alert('Произошла ошибка при завершении урока.');
                    showTemporaryAlert('Произошла ошибка при завершении урока.', 'danger');
                }
            });
        } else {
            // alert('Выберите урок для завершения.');
            showTemporaryAlert('Выберите урок для завершения.', 'warning');
        }
    });

    $('#close-lesson-viewer').click(function () {
        $('#lesson-viewer').fadeOut();
    });

    // Функция для отображения временных уведомлений (Bootstrap alerts)
    function showTemporaryAlert(message, type = 'info') {
        const alertContainer = $('#temporary-alert-container');
        if (alertContainer.length === 0) {
            // Создаем контейнер, если его нет
            $('<div id="temporary-alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>').appendTo('body');
        }
        const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width: 250px;">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>`;
        const newAlert = $(alertHtml);
        $('#temporary-alert-container').append(newAlert);

        // Автоматическое скрытие через 5 секунд
        setTimeout(function() {
            newAlert.alert('close');
        }, 5000);
    }

    // Явное закрытие по крестику (на случай, если Bootstrap JS не сработал)
    $(document).on('click', '.alert-dismissible .close', function() {
        $(this).closest('.alert').alert('close');
    });

    $(document).on('click', '.finish-module-btn', function() {
        var moduleId = $(this).data('module-id');
        var courseId = $(this).data('course-id');
        var btn = $(this);
        btn.prop('disabled', true);
        $.ajax({
            url: '/mark-module-complete/',
            type: 'POST',
            data: {
                module_id: moduleId,
                course_id: courseId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showTemporaryAlert('Модуль успешно завершён!', 'success');
                    setTimeout(function() { location.reload(); }, 800);
                } else {
                    showTemporaryAlert(response.error || 'Ошибка при завершении модуля.', 'danger');
                    btn.prop('disabled', false);
                }
            },
            error: function(xhr) {
                showTemporaryAlert('Ошибка при завершении модуля.', 'danger');
                btn.prop('disabled', false);
            }
        });
    });
});
</script>
</body>
</html>