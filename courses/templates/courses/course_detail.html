{% load static %}
{% load course_extras %}
{% load course_filters %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ course.title }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Raleway:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <style>
<<<<<<< HEAD
=======
        
>>>>>>> 183dfa0248c37f3942309b11103b72706fcd0bd0
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-right: 4px;
            margin-left: 30px;
        }
        .header-logo-stretch {
            height: 150px;
            width: auto;
            object-fit: contain;
            background: transparent;
            align-self: center;
        }
        .header-flex-row {
            display: flex;
            align-items: stretch;
        }
    </style>
</head>
<body>
<<<<<<< HEAD
<header class="course-header">
    <div class="header-flex-row">
        <div class="logo-container">
            <img src="/media/logo.png" alt="Logo" class="header-logo-stretch">
        </div>
        <div class="container d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div class="d-flex flex-column flex-md-row align-items-center gap-3">
                <div class="course-title">{{ course.title }}</div>
            </div>
            <div class="header-btns">
                <a href="{% url 'student_page' %}" class="btn btn-profile"><i class="fas fa-arrow-left mr-1"></i>Назад</a>
                <a href="{% url 'logout' %}" class="btn btn-logout"><i class="fas fa-sign-out-alt mr-1"></i>Выйти</a>
            </div>
        </div>
    </div>
</header>
=======
    <header class="course-header">
        <div class="header-flex-row">
            <div class="logo-container">
                <img src="/media/logo.png" alt="Logo" class="header-logo-stretch">
            </div>
            <div class="container d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex flex-column flex-md-row align-items-center gap-3">
                    <div class="course-title">{{ course.title }}</div>
                </div>
                <div class="header-btns">
                    <a href="{% url 'student_page' %}" class="btn btn-profile"><i class="fas fa-arrow-left mr-1"></i>Назад</a>
                    <a href="{% url 'logout' %}" class="btn btn-logout"><i class="fas fa-sign-out-alt mr-1"></i>Выйти</a>
                </div>
            </div>
        </div>
    </header>
>>>>>>> 183dfa0248c37f3942309b11103b72706fcd0bd0
<div class="course-progress-block-wide mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <span class="course-progress-label-wide">Общий прогресс по курсу:</span>
        <div class="progress course-progress-main-wide flex-grow-1 mx-3">
            <div class="progress-bar" role="progressbar"
                 style="width: {{ course_progress|default:0 }}%"
                 aria-valuenow="{{ course_progress|default:0 }}" aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <span class="progress-percentage-wide">{{ course_progress|default:0 }}%</span>
    </div>
</div>
<main class="course-main d-flex">
    <aside class="sidebar-modules">
        <div class="sidebar-title">Модули и уроки</div>
        <div class="sidebar-modules-list">
            {% for module in course.modules.all %}
                <div class="sidebar-module {% if module.id not in unlocked_modules_ids %}disabled{% endif %}">
                    <div class="sidebar-module-title">
                        {{ module.title }}
                        {% if module.id in completed_modules_ids %}
                            <span class="badge badge-success ml-2" title="Модуль завершён!">Модуль завершён!</span>
                        {% elif module.id not in unlocked_modules_ids %}
                            <span class="locked-icon" title="Завершите предыдущий модуль"><i class="fas fa-lock"></i></span>
                        {% endif %}
                    </div>
                    <ul class="sidebar-lessons-list">
                        {% for lesson in module.lessons.all %}
                            <li class="lesson-link{% if module.id not in unlocked_modules_ids or lesson.id != next_lesson_id_by_module|get_item:module.id and lesson.id not in completed_lessons %} disabled{% endif %}"
                                data-lesson-id="{{ lesson.id }}"
                                data-video-url="{% if lesson.video %}{{ lesson.video.url }}{% elif lesson.video_url %}{{ lesson.video_url }}{% endif %}"
                                data-pdf-url="{% if lesson.pdf and not lesson.convert_pdf_to_slides %}{{ lesson.pdf.url }}{% endif %}">
                                {% if lesson.id in completed_lessons %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% endif %}
                                <span title="{{ lesson.title }}">{{ lesson.title }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                    <ul class="sidebar-quiz-list">
                        {% for quiz in module.quizzes.all %}
                        <li>
                            <a href="{% url 'start_quiz' quiz.id %}" class="quiz-link {% if module.id not in unlocked_modules_ids %}disabled{% endif %}"
                               {% if module.id not in unlocked_modules_ids %}style="pointer-events:none;cursor:not-allowed;" tabindex="-1" aria-disabled="true"{% endif %}
                               data-quiz-id="{{ quiz.id }}"
                               data-quiz-title="{{ quiz.title }}"
                               data-quiz-questions="{{ quiz.questions.count }}"
                               data-quiz-stars="{{ quiz.stars }}"
                               title="{{ quiz.title }}">
                                <i class="fas fa-question-circle text-warning mr-2"></i>Квиз: {{ quiz.title }}
                            </a>
                            {% with result=quiz_results|get_item:quiz.id %}
                                {% if result %}
                                    <span class="quiz-result" title="{% if result.passed %}Сдан ({{ result.score }}%) {% else %}Не сдан ({{ result.score }}%) {% endif %}">
                                        {% if result.passed %}
                                            <i class="fas fa-check-circle text-success"></i> Сдан ({{ result.score }}%)
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i> Не сдан ({{ result.score }}%)
                                        {% endif %}
                                    </span>
                                {% endif %}
                            {% endwith %}
                        </li>
<<<<<<< HEAD
                    {% endfor %}
                </ul>
                <ul class="sidebar-quiz-list">
                    {% for quiz in module.quizzes.all %}
                    <li>
                        <a href="{% url 'start_quiz' quiz.id %}" class="quiz-link">
                            <i class="fas fa-question-circle text-warning mr-2"></i>Квиз: {{ quiz.title }}
                        </a>
                        {% with result=quiz_results|get_item:quiz.id %}
                            {% if result %}
                                <span class="quiz-result">
                                    {% if result.passed %}
                                        <i class="fas fa-check-circle text-success"></i> Сдан ({{ result.score }}%)
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger"></i> Не сдан ({{ result.score }}%)
                                    {% endif %}
                                </span>
                            {% endif %}
                        {% endwith %}
                    </li>
                    {% endfor %}
                </ul>
                {% if module_can_be_completed|get_item:module.id %}
                <div class="text-center my-2">
                    <button class="btn btn-primary btn-block finish-module-btn" data-module-id="{{ module.id }}" data-course-id="{{ course.id }}">
                        <i class="fas fa-flag-checkered mr-1"></i> Завершить модуль
                    </button>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="sidebar-module disabled">
                <div class="sidebar-module-title">{{ module.title }} <span class="locked-icon" title="Завершите предыдущий модуль"><i class="fas fa-lock"></i></span></div>
                <ul class="sidebar-lessons-list">
                    {% for lesson in module.lessons.all %}
                        <li class="lesson-link disabled">
                            <span>{{ lesson.title }}</span>
                        </li>
                    {% endfor %}
                </ul>
                <ul class="sidebar-quiz-list">
                    {% for quiz in module.quizzes.all %}
                    <li class="quiz-link disabled">
                        <span>Квиз: {{ quiz.title }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
=======
                        {% endfor %}
                    </ul>
                    {% if module.id in unlocked_modules_ids and module_can_be_completed|dict_get:module.id %}
                        <button class="btn btn-success btn-block mt-2 mark-module-complete-btn" data-module-id="{{ module.id }}" data-course-id="{{ course.id }}">Завершить модуль</button>
                    {% endif %}
                </div>
>>>>>>> 183dfa0248c37f3942309b11103b72706fcd0bd0
            {% endfor %}
        </div>
    </aside>
    <section class="main-course-content flex-grow-1">
        <div id="lesson-viewer" class="lesson-viewer mt-4" style="display:none;">
            <div class="lesson-viewer-card">
                <h2 class="text-center mb-4" id="lesson-viewer-title"></h2>
                <div id="lesson-tabs-container">
                    <ul class="nav nav-tabs" id="lessonTabNav" role="tablist" style="display:none;">
                        <li class="nav-item" id="video-tab-li">
                            <a class="nav-link active" id="video-tab" data-toggle="tab" href="#video-tab-pane" role="tab" aria-controls="video-tab-pane" aria-selected="true">Видео</a>
                        </li>
                        <li class="nav-item" id="slides-tab-li">
                            <a class="nav-link" id="slides-tab" data-toggle="tab" href="#slides-tab-pane" role="tab" aria-controls="slides-tab-pane" aria-selected="false">Слайды</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="lessonTabContent">
                        <div class="tab-pane fade show active" id="video-tab-pane" role="tabpanel" aria-labelledby="video-tab">
                            <div id="video-container" class="mb-4"></div>
                        </div>
                        <div class="tab-pane fade" id="slides-tab-pane" role="tabpanel" aria-labelledby="slides-tab">
                            <div id="pdf-slider-container" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <button id="prev-slide-btn" class="btn btn-primary"><i class="fas fa-chevron-left"></i> Назад</button>
                                    <span id="slide-info" class="fw-bold"></span>
                                    <button id="next-slide-btn" class="btn btn-primary">Вперед <i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="text-center mb-3">
                                    <img id="current-slide-img" src="" alt="Lesson Slide" class="img-fluid" style="max-height: 70vh;" />
                                </div>
                                <div class="text-center">
                                    <button id="fullscreen-btn" class="btn btn-info"><i class="fas fa-expand"></i> Полный экран</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <a id="pdf-link" href="#" target="_blank" class="btn btn-secondary mb-4" style="display: none;">Открыть PDF</a>
                <div class="text-center mt-4">
                    <button id="close-lesson-viewer" class="btn btn-danger"><i class="fas fa-times"></i> Закрыть</button>
                    <button id="mark-complete-btn" class="btn btn-success ml-2" style="display:none;"><i class="fas fa-check"></i> Завершить и продолжить</button>
                </div>
            </div>
        </div>
    </section>
</main>
<div id="quiz-info-modal" class="modal" tabindex="-1" role="dialog" style="display:none; background:rgba(0,0,0,0.3);">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quiz-info-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#quiz-info-modal').fadeOut();">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-2">Чтобы начать квиз, нужно выполнить все уроки модуля.</div>
        <p id="quiz-info-questions"></p>
        <p id="quiz-info-stars"></p>
      </div>
      <div class="modal-footer">
        <a id="quiz-info-start-btn" href="#" class="btn btn-primary">Начать квиз</a>
      </div>
    </div>
  </div>
</div>
<div id="module-complete-modal" class="modal" tabindex="-1" role="dialog" style="display:none; background:rgba(0,0,0,0.3);">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Вы прошли модуль!</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#module-complete-modal').fadeOut();">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Поздравляем! Вы успешно завершили модуль.</p>
      </div>
      <div class="modal-footer">
        <button id="go-next-module-btn" class="btn btn-primary">Перейти к следующему модулю</button>
      </div>
    </div>
  </div>
</div>
<div id="quiz-locked-modal" class="modal" tabindex="-1" role="dialog" style="display:none; background:rgba(0,0,0,0.3);">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Квиз недоступен</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#quiz-locked-modal').fadeOut();">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Чтобы разблокировать квиз, пройдите все уроки модуля.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#quiz-locked-modal').fadeOut();">Понятно</button>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

{# Этот скрипт содержит данные о слайдах, безопасно сериализованные Django #}
{{ all_lesson_slides_data|json_script:"all-lesson-slides-data" }}
{{ first_20_video_lessons|json_script:"first-20-video-lessons" }}

<script>
function showTemporaryAlert(message, type = 'info') {
    const alertContainer = $('#temporary-alert-container');
    if (alertContainer.length === 0) {
        $('<div id="temporary-alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>').appendTo('body');
    }
    const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width: 250px;">
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>`;
    const newAlert = $(alertHtml);
    $('#temporary-alert-container').append(newAlert);
    setTimeout(function() {
        newAlert.alert('close');
    }, 5000);
}
$(document).on('click', '.alert-dismissible .close', function() {
    $(this).closest('.alert').alert('close');
});

$(document).ready(function () {
    const allLessonSlidesData = JSON.parse(document.getElementById('all-lesson-slides-data').textContent);
    const first20VideoLessons = JSON.parse(document.getElementById('first-20-video-lessons').textContent);

    var currentLessonSlides = [];
    var currentSlideIndex = 0;
    var currentLessonId = null;
    var currentCourseId = {{ course.id }};
    var lessonStartTime = null;
    var timerInterval = null;
    var timerPassed = false;
    var slidesViewed = false;
    const REQUIRED_SECONDS = 20;

    function updateSlideDisplay() {
        if (currentLessonSlides && currentLessonSlides.length > 0) {
            $('#current-slide-img').attr('src', currentLessonSlides[currentSlideIndex]);
            $('#slide-info').text(`${currentSlideIndex + 1} / ${currentLessonSlides.length}`);
            $('#prev-slide-btn').prop('disabled', currentSlideIndex === 0);
            $('#next-slide-btn').prop('disabled', currentSlideIndex === currentLessonSlides.length - 1);
            // Проверяем, долистал ли до конца
            slidesViewed = (currentSlideIndex === currentLessonSlides.length - 1);
            checkLessonCompleteReady();
        }
    }

    function startLessonTimer() {
        lessonStartTime = Date.now();
        timerPassed = false;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            const elapsed = Math.floor((Date.now() - lessonStartTime) / 1000);
            const left = Math.max(0, REQUIRED_SECONDS - elapsed);
            console.log('Таймер урока:', left, 'секунд осталось');
            if (elapsed >= REQUIRED_SECONDS) {
                timerPassed = true;
                clearInterval(timerInterval);
                checkLessonCompleteReady();
            }
        }, 1000);
    }

    function checkLessonCompleteReady() {
        if (timerPassed) {
            $('#mark-complete-btn').show();
        } else {
            $('#mark-complete-btn').hide();
        }
    }

    $('#prev-slide-btn').click(function () {
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            updateSlideDisplay();
            checkLessonCompleteReady();
        }
    });

    $('#next-slide-btn').click(function () {
        if (currentSlideIndex < currentLessonSlides.length - 1) {
            currentSlideIndex++;
            updateSlideDisplay();
            checkLessonCompleteReady();
        }
    });

    $('#fullscreen-btn').click(function () {
        const img = $('#current-slide-img')[0];
        if (img.requestFullscreen) {
            img.requestFullscreen();
        } else if (img.mozRequestFullScreen) { /* Firefox */
            img.mozRequestFullScreen();
        } else if (img.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
            img.webkitRequestFullscreen();
        } else if (img.msRequestFullscreen) { /* IE/Edge */
            img.msRequestFullscreen();
        }
    });

    function showLessonTabs(hasVideo, hasSlides) {
        if (hasVideo && hasSlides) {
            $('#lessonTabNav').show();
            $('#video-tab-li').show();
            $('#slides-tab-li').show();
            $('#video-tab').addClass('active');
            $('#video-tab-pane').addClass('show active');
            $('#slides-tab').removeClass('active');
            $('#slides-tab-pane').removeClass('show active');
        } else if (hasVideo) {
            $('#lessonTabNav').hide();
            $('#video-tab-li').show();
            $('#slides-tab-li').hide();
            $('#video-tab-pane').addClass('show active');
            $('#slides-tab-pane').removeClass('show active');
        } else if (hasSlides) {
            $('#lessonTabNav').hide();
            $('#video-tab-li').hide();
            $('#slides-tab-li').show();
            $('#video-tab-pane').removeClass('show active');
            $('#slides-tab-pane').addClass('show active');
        } else {
            $('#lessonTabNav').hide();
            $('#video-tab-li').hide();
            $('#slides-tab-li').hide();
            $('#video-tab-pane').removeClass('show active');
            $('#slides-tab-pane').removeClass('show active');
        }
    }

    $(document).on('click', '.lesson-link:not(.disabled)', function () {
        currentLessonId = $(this).data('lesson-id');
        const videoUrl = $(this).data('video-url');
        const pdfUrl = $(this).data('pdf-url');
        let slidesData = allLessonSlidesData[currentLessonId];
        const lessonTitle = $(this).text().trim();
        $('#lesson-viewer-title').text(lessonTitle);
        // Скрываем все контейнеры по умолчанию
        $('#video-container').empty().hide();
        $('#pdf-link').hide();
        $('#pdf-slider-container').hide();
        $('#mark-complete-btn').hide();
        timerPassed = false;
        startLessonTimer();
        checkLessonCompleteReady();
        let hasVideo = !!videoUrl;
        let hasSlides = slidesData && slidesData.length > 0;
        showLessonTabs(hasVideo, hasSlides);
        // Видео
        if (hasVideo) {
            let embedHtml = '';
            let isYouTube = false;
            let isLocalVideo = false;
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                isYouTube = true;
                let videoId = '';
                if (videoUrl.includes('youtube.com/watch')) {
                    videoId = videoUrl.split('v=')[1];
                    const ampersandPosition = videoId.indexOf('&');
                    if (ampersandPosition !== -1) {
                        videoId = videoId.substring(0, ampersandPosition);
                    }
                } else if (videoUrl.includes('youtu.be/')) {
                    videoId = videoUrl.split('youtu.be/')[1];
                }
                if (videoId) {
                    embedHtml = `<div class="video-embed-container"><iframe id="yt-player" class="embedded-video-iframe" src="https://www.youtube.com/embed/${videoId}?enablejsapi=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                }
            } else if (videoUrl.match(/\.mp4($|\?)/) || videoUrl.includes('dropbox.com')) {
                isLocalVideo = true;
                let src = videoUrl;
                if (videoUrl.includes('dropbox.com')) {
                    src = videoUrl.replace('?dl=0', '?dl=1');
                }
                embedHtml = `<video id="lesson-video" controls class="local-video-player"><source src="${src}" type="video/mp4">Ваш браузер не поддерживает видео.</video>`;
            }
            if (embedHtml) {
                $('#video-container').html(embedHtml).show();
            } else {
                $('#video-container').html('<p class="text-danger">Не удалось загрузить видео или неподдерживаемый формат.</p>').show();
            }
        }
        // Слайды
        if (hasSlides) {
            currentLessonSlides = slidesData;
            currentSlideIndex = 0;
            updateSlideDisplay();
            $('#pdf-slider-container').show();
        }
        // Вкладки: обработка кликов
        if (hasVideo && hasSlides) {
            $('#lessonTabNav').show();
            $('#video-tab').off('click').on('click', function(e) {
                e.preventDefault();
                $('#video-tab').addClass('active');
                $('#slides-tab').removeClass('active');
                $('#video-tab-pane').addClass('show active');
                $('#slides-tab-pane').removeClass('show active');
                $('#video-container').show();
                $('#pdf-slider-container').hide();
            });
            $('#slides-tab').off('click').on('click', function(e) {
                e.preventDefault();
                $('#slides-tab').addClass('active');
                $('#video-tab').removeClass('active');
                $('#slides-tab-pane').addClass('show active');
                $('#video-tab-pane').removeClass('show active');
                $('#video-container').hide();
                $('#pdf-slider-container').show();
            });
        }
        $('#lesson-viewer').fadeIn();
        $('html,body').animate({scrollTop: $('#lesson-viewer').offset().top-40}, 400);
    });

    $('#close-lesson-viewer').click(function () {
        $('#lesson-viewer').fadeOut();
    });

    $('#mark-complete-btn').off('click').on('click', function() {
        if (currentLessonId) {
            $.ajax({
                url: '{% url "mark_lesson_complete" %}',
                type: 'POST',
                data: {
                    lesson_id: currentLessonId,
                    course_id: currentCourseId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        const completedLessonLink = $('.lesson-link[data-lesson-id="' + response.completed_lesson_id + '"]');
                        if (!completedLessonLink.find('.fa-check-circle').length) {
                            completedLessonLink.prepend('<i class="fas fa-check-circle text-success" style="margin-right:7px;"></i>');
                        }
                        completedLessonLink.removeClass('disabled');
                        $('.course-progress-main-wide .progress-bar').css('width', `${response.new_progress}%`);
                        $('.progress-percentage-wide').text(`${response.new_progress}%`);

                        // Определяем, последний ли это урок в модуле
                        var $module = completedLessonLink.closest('.sidebar-module');
                        var allLessons = $module.find('.lesson-link');
                        var completedLessons = $module.find('.lesson-link .fa-check-circle').closest('.lesson-link');
                        var isLastLesson = (allLessons.length === completedLessons.length);
                        var quizzes = $module.find('.quiz-link');
                        if (isLastLesson) {
                            if (quizzes.length > 0) {
                                // Открыть модалку квиза для первого квиза
                                var $firstQuiz = quizzes.first();
                                var quizId = $firstQuiz.data('quiz-id');
                                var quizTitle = $firstQuiz.data('quiz-title');
                                var questionsCount = $firstQuiz.data('quiz-questions');
                                var stars = $firstQuiz.data('quiz-stars');
                                var startUrl = $firstQuiz.attr('href');
                                showQuizInfo(quizId, quizTitle, questionsCount, stars, startUrl);
                            } else {
                                // Нет квиза — показать модалку завершения модуля
                                var $completeBtn = $module.find('.mark-module-complete-btn');
                                if ($completeBtn.length) {
                                    $completeBtn.show();
                                    $('#lesson-viewer').fadeOut(function(){
                                        $('#module-complete-modal').fadeIn();
                                    });
                                }
                            }
                            $('#lesson-viewer').fadeOut();
                        } else {
                            // Обычное поведение: переход к следующему уроку
                            if (response.next_lesson_id) {
                                const nextLessonLink = $('.lesson-link[data-lesson-id="' + response.next_lesson_id + '"]');
                                if (nextLessonLink.length) {
                                    nextLessonLink.removeClass('disabled');
                                    $('#lesson-viewer').fadeOut(function(){
                                        setTimeout(function() {
                                            nextLessonLink.click();
                                        }, 200);
                                    });
                                } else {
                                    $('#lesson-viewer').fadeOut();
                                }
                            } else {
                                $('#lesson-viewer').fadeOut();
                            }
                        }
                        // Показать кнопку Завершить модуль, если все уроки и квизы завершены
                        var allLessonsCompleted = $module.find('.lesson-link').length === $module.find('.lesson-link .fa-check-circle').length;
                        var allQuizzesPassed = true;
                        $module.find('.sidebar-quiz-list .quiz-result').each(function() {
                            if (!$(this).find('.fa-check-circle').length) {
                                allQuizzesPassed = false;
                            }
                        });
                        if (allLessonsCompleted && allQuizzesPassed) {
                            var $completeBtn = $module.find('.mark-module-complete-btn');
                            if ($completeBtn.length) {
                                $completeBtn.show();
                            }
                        }
                    } else {
                        // showTemporaryAlert(response.message, 'info'); // УДАЛЕНО
                    }
                },
                error: function(xhr, status, error) {
                    // showTemporaryAlert('Произошла ошибка при завершении урока.', 'danger'); // УДАЛЕНО
                }
            });
        } else {
            // showTemporaryAlert('Выберите урок для завершения.', 'warning'); // УДАЛЕНО
        }
    });

    $('.mark-module-complete-btn').click(function() {
        var moduleId = $(this).data('module-id');
        var courseId = $(this).data('course-id');
        var btn = $(this);
        $.ajax({
            url: '{% url "mark_module_complete" %}',
            type: 'POST',
            data: {
                module_id: moduleId,
                course_id: courseId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Найти следующий модуль
                    var $currentModule = btn.closest('.sidebar-module');
                    var $nextModule = $currentModule.nextAll('.sidebar-module:not(.disabled)').first();
                    var $firstLesson = $nextModule.find('.lesson-link').not('.disabled').first();
                    $('#module-complete-modal').fadeIn();
                    $('#go-next-module-btn').off('click').on('click', function() {
                        $('#module-complete-modal').fadeOut();
                        if ($firstLesson.length) {
                            $firstLesson.click();
                        } else {
                            window.location.href = '{% url "student_page" %}';
                        }
                    });
                } else {
                    // showTemporaryAlert(response.error || 'Ошибка завершения модуля', 'danger'); // УДАЛЕНО
                }
            },
            error: function(xhr) {
                // showTemporaryAlert('Ошибка завершения модуля', 'danger'); // УДАЛЕНО
            }
        });
    });

    // Функция для показа инфо о квизе
    function showQuizInfo(quizId, quizTitle, questionsCount, stars, startUrl) {
        $('#quiz-info-title').text(quizTitle);
        $('#quiz-info-questions').text('Вопросов: ' + questionsCount);
        $('#quiz-info-stars').text('Звёзд за квиз: ' + stars);
        // Проверяем, доступен ли квиз (есть ли .quiz-link с data-quiz-id и без disabled)
        var $sidebarQuiz = $('.quiz-link[data-quiz-id="' + quizId + '"]');
        var isAvailable = !$sidebarQuiz.hasClass('disabled');
        var $startBtn = $('#quiz-info-start-btn');
        $startBtn.attr('href', isAvailable ? startUrl : '#');
        $startBtn.prop('disabled', !isAvailable);
        if (!isAvailable) {
            $startBtn.addClass('disabled');
        } else {
            $startBtn.removeClass('disabled');
        }
        $('#quiz-info-modal').fadeIn();
    }

    // Клик по квизу слева
    $(document).on('click', '.quiz-link:not(.disabled)', function(e) {
        e.preventDefault();
        var $quiz = $(this);
        var quizId = $quiz.data('quiz-id');
        var quizTitle = $quiz.data('quiz-title');
        var questionsCount = $quiz.data('quiz-questions');
        var stars = $quiz.data('quiz-stars');
        var startUrl = $quiz.attr('href');
        showQuizInfo(quizId, quizTitle, questionsCount, stars, startUrl);
    });

    $(document).on('click', '.quiz-link.disabled', function(e) {
        e.preventDefault();
        $('#quiz-locked-modal').fadeIn();
    });

    $(document).on('click', '.finish-module-btn', function() {
        var moduleId = $(this).data('module-id');
        var courseId = $(this).data('course-id');
        var btn = $(this);
        btn.prop('disabled', true);
        $.ajax({
            url: '/mark-module-complete/',
            type: 'POST',
            data: {
                module_id: moduleId,
                course_id: courseId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showTemporaryAlert('Модуль успешно завершён!', 'success');
                    setTimeout(function() { location.reload(); }, 800);
                } else {
                    showTemporaryAlert(response.error || 'Ошибка при завершении модуля.', 'danger');
                    btn.prop('disabled', false);
                }
            },
            error: function(xhr) {
                showTemporaryAlert('Ошибка при завершении модуля.', 'danger');
                btn.prop('disabled', false);
            }
        });
    });
});
</script>
</body>
</html>